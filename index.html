<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>PSN Tracker</title>
  <style>
    body { font-family: Roboto, Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; color: #222; }
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 25px; background: linear-gradient(135deg, #3f51b5, #283593);
      color: white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    header h1 { margin: 0; font-size: 22px; }

    .controls { text-align: center; margin: 15px 0; }
    .controls input, .controls select { padding: 6px; border-radius: 4px; border: 1px solid #ccc; }

    #out { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 20px; }
    .game-card {
      background: white; color: black; border: 1px solid #ccc;
      border-radius: 8px; width: 240px; padding: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
    }
    .game-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
    .game-card img.cover { width: 100%; border-radius: 6px; }
    .game-title { font-weight: bold; margin: 8px 0 4px 0; font-size: 15px; }
    .small-info { font-size: 12px; color: #666; }
    .trophy-count { display: flex; gap: 6px; align-items: center; font-size: 13px; margin-top: 6px; }
    .trophy-count img { width: 18px; vertical-align: middle; }
    .progress-bar { background: #ddd; border-radius: 4px; overflow: hidden; height: 10px; margin-top: 6px; }
    .progress-bar div { height: 10px; background: linear-gradient(90deg,#4caf50,#81c784); }

    /* Modal */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
    .modal-content { background:#fff; padding:20px; border-radius:8px; width:700px; max-height:85%; overflow-y:auto; }
    .modal h2 { margin-top:0; }
    .trophy { border-bottom:1px solid #ddd; padding:8px 0; }
    .trophy:last-child { border-bottom:none; }
    .trophy img { width:20px; vertical-align:middle; margin-right:6px; }
    .close-btn { background:#f44336; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; float:right; }
    
    .btn-sync {
  background: linear-gradient(135deg, #3f51b5, #283593);
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  transition: background 0.3s, transform 0.2s;
}
.btn-sync:hover {
  background: linear-gradient(135deg, #5c6bc0, #3949ab);
  transform: translateY(-2px);
}
.btn-sync:active {
  transform: scale(0.95);
}

  </style>
</head>
<body>
  <header>
    <h1>üéÆ PSN Tracker</h1>
  </header>

  <div class="controls">
  <input id="npsso" placeholder="Wklej NPSSO (64 znaki)" size="40">
  <button class="btn-sync" onclick="sync()">üîÑ Synchronizuj</button>
  <label>Sortuj:
    <select id="sort" onchange="renderGames()">
      <option value="name">Po nazwie</option>
      <option value="progressAsc">Progres rosnƒÖco</option>
      <option value="progressDesc">Progres malejƒÖco</option>
      <option value="platDesc">Najwiƒôcej platyn</option>
    </select>
  </label>
</div>


  <div id="out"></div>

  <!-- Modal -->
<div id="gameModal" class="modal" onclick="closeModal(event)">
  <div class="modal-content">
    <button class="close-btn" onclick="document.getElementById('gameModal').style.display='none'">Zamknij</button>
    <h2 id="modalTitle"></h2>
    <p id="modalInfo"></p>
    <div class="progress-bar"><div id="modalProgress"></div></div>
    <h3>Trofea podstawowe</h3>
    <div id="modalBase"></div>
    <h3>Trofea DLC</h3>
    <div id="modalDlc"></div>
  </div>
</div>


<script>
let gamesData = [];

async function sync() {
  const npsso = document.getElementById("npsso").value;
  const res = await fetch("http://localhost:4000/api/sync", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ npsso })
  });
  const data = await res.json();
  gamesData = data.games;
  renderGames();
}

function renderGames() {
  let sort = document.getElementById("sort").value;
  let list = [...gamesData];

  if (sort === "name") list.sort((a,b) => a.trophyTitleName.localeCompare(b.trophyTitleName));
  else if (sort === "progressAsc") list.sort((a,b) => a.progress - b.progress);
  else if (sort === "progressDesc") list.sort((a,b) => b.progress - a.progress);
  else if (sort === "platDesc") list.sort((a,b) => (b.earnedTrophies?.platinum || 0) - (a.earnedTrophies?.platinum || 0));

  document.getElementById("out").innerHTML = list.map(g => {
    const t = g.earnedTrophies || { platinum:0,gold:0,silver:0,bronze:0 };
    const total = (g.definedTrophies?.bronze||0)+(g.definedTrophies?.silver||0)+(g.definedTrophies?.gold||0)+(g.definedTrophies?.platinum||0);
    return `
      <div class="game-card" onclick="showDetails('${g.npCommunicationId}','${g.trophyTitleName}','${g.trophyTitlePlatform}',${g.progress})">
        <img src="${g.trophyTitleIconUrl}" class="cover">
        <div class="game-title">${g.trophyTitleName}</div>
        <div class="small-info">${t.platinum+t.gold+t.silver+t.bronze} / ${total} trofe√≥w</div>
        <div class="trophy-count">
          <img src="https://img.icons8.com/ios-filled/50/795548/trophy.png"> ${t.bronze}
          <img src="https://img.icons8.com/ios-filled/50/c0c0c0/trophy.png"> ${t.silver}
          <img src="https://img.icons8.com/ios-filled/50/ffd700/trophy.png"> ${t.gold}
          <img src="https://img.icons8.com/ios-filled/50/00bcd4/trophy.png"> ${t.platinum}
        </div>
        <div class="progress-bar"><div style="width:${g.progress}%"></div></div>
        <span>${g.progress}%</span>
      </div>
    `;
  }).join("");
}

async function showDetails(id, name, platform, progress) {
  const npsso = document.getElementById("npsso").value;
  const res = await fetch("http://localhost:4000/api/gameDetails", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ npsso, npCommunicationId: id, platform })
  });
  const data = await res.json();

  document.getElementById("modalTitle").innerText = name;
  document.getElementById("modalInfo").innerHTML = `<b>Platforma:</b> ${platform}<br><b>Wydawca:</b> ${data.gameInfo.publisher}<br><b>Opis:</b> ${data.gameInfo.description}`;
  document.getElementById("modalProgress").style.width = progress + "%";

  const makeTrophyHtml = (t) => {
  let icon = "https://img.icons8.com/ios-filled/50/795548/trophy.png";
  if (t.trophyType === "silver") icon = "https://img.icons8.com/ios-filled/50/c0c0c0/trophy.png";
  if (t.trophyType === "gold") icon = "https://img.icons8.com/ios-filled/50/ffd700/trophy.png";
  if (t.trophyType === "platinum") icon = "https://img.icons8.com/ios-filled/50/00bcd4/trophy.png";
  return `
    <div class="trophy">
      <img src="${icon}"><b>${t.trophyName}</b><br>
      ${t.trophyDetail || ""}<br>
      ${t.earned ? "‚úÖ Zdobyte" : "‚ùå Niezdobyte"}
    </div>
  `;
};


  document.getElementById("modalBase").innerHTML = data.trophies.baseGame.map(makeTrophyHtml).join("");
  document.getElementById("modalDlc").innerHTML = data.trophies.dlc.map(makeTrophyHtml).join("");

  document.getElementById("gameModal").style.display = "flex";
}

function closeModal(e) {
  if (e.target.classList.contains("modal")) {
    document.getElementById("gameModal").style.display = "none";
  }
}
</script>
</body>
</html>
